
# 1. åŠ è½½æ‰€éœ€çš„åŒ…
library(ChIPseeker)
library(TxDb.Drerio.UCSC.danRer11.refGene)
library(org.Dr.eg.db)

cat("æ‰€æœ‰åŒ…å·²æˆåŠŸåŠ è½½ã€‚\n")

# 2. è¯»å–æ‚¨çš„å·®å¼‚peakæ–‡ä»¶
peak_file <- "all_differential_peaks.csv"
peak_data <- read.csv(peak_file)
peak <- makeGRangesFromDataFrame(peak_data,
                                 keep.extra.columns=TRUE,
                                 seqnames.field="chr",
                                 start.field="start",
                                 end.field="end")

cat("æˆåŠŸè¯»å–å¹¶è½¬æ¢äº†", length(peak), "ä¸ªå·®å¼‚peakã€‚\n")
cat("Peakæ–‡ä»¶ä¸­çš„æŸ“è‰²ä½“åç¤ºä¾‹: ", head(seqlevels(peak), 5), "\n")
txdb <- TxDb.Drerio.UCSC.danRer11.refGene # å®šä¹‰æ–‘é©¬é±¼æ³¨é‡Šæ•°æ®åº“
cat("æ³¨é‡Šåº“ä¸­çš„æŸ“è‰²ä½“åç¤ºä¾‹: ", head(seqlevels(txdb), 5), "\n")

# ä¸ºpeakçš„æŸ“è‰²ä½“åç§°ç»Ÿä¸€åŠ ä¸Š"chr"å‰ç¼€
cat("æ­£åœ¨ä¿®æ”¹peakçš„æŸ“è‰²ä½“åä»¥åŒ¹é…æ³¨é‡Šåº“...\n")
seqlevels(peak) <- paste0("chr", seqlevels(peak))

# å†æ¬¡æ£€æŸ¥ä¿®æ”¹åçš„åç§°ï¼ˆå¯é€‰ï¼‰
cat("ä¿®æ”¹åçš„PeakæŸ“è‰²ä½“åç¤ºä¾‹: ", head(seqlevels(peak), 5), "\n")
# 3. å¯¹Peakè¿›è¡Œæ³¨é‡Š
txdb <- TxDb.Drerio.UCSC.danRer11.refGene # å®šä¹‰æ–‘é©¬é±¼æ³¨é‡Šæ•°æ®åº“
peakAnno <- annotatePeak(peak, tssRegion=c(-3000, 3000),
                         TxDb=txdb,
                         annoDb="org.Dr.eg.db")

cat("æ³¨é‡Šå®Œæˆï¼\n")

# 4. å¯è§†åŒ–å¹¶å¯¼å‡ºç»“æœ
png("peak_annotation_barplot.png", width=800, height=600)
plotAnnoBar(peakAnno)
dev.off()

png("peak_distance_to_TSS.png", width=800, height=600)
plotDistToTSS(peakAnno, title="Distribution of binding loci relative to TSS")
dev.off()

output_file <- "all_differential_peaks_annotated.csv"
write.csv(as.data.frame(peakAnno), file=output_file, row.names = FALSE)

cat("åˆ†æå®Œæˆï¼ç»“æœå·²ä¿å­˜åˆ°æ‚¨çš„å·¥ä½œç›®å½•ã€‚\n")






# é¦–å…ˆï¼Œç›´æ¥æ‰“å°ä¸€ä¸‹ peakAnno å¯¹è±¡çš„æ‘˜è¦ä¿¡æ¯ï¼Œäº²çœ¼çœ‹çœ‹ç»“æœ
print(peakAnno)

# ç°åœ¨ï¼Œä¹‹å‰çš„ç”»å›¾å‘½ä»¤å¯ä»¥æˆåŠŸè¿è¡Œäº†
png("peak_annotation_barplot.png", width=1000, height=800)
plotAnnoBar(peakAnno)
dev.off()

# ç»˜åˆ¶åˆ°TSSçš„è·ç¦»åˆ†å¸ƒå›¾
png("peak_distance_to_TSS.png", width=800, height=600)
plotDistToTSS(peakAnno, title="Distribution of binding loci relative to TSS")
dev.off()

# ğŸ“„ æœ€é‡è¦çš„ä¸€æ­¥ï¼šå°†æ‚¨çš„æ³¨é‡Šç»“æœä¿å­˜ä¸ºCSVè¡¨æ ¼æ–‡ä»¶ï¼
# è¿™ä¸ªæ–‡ä»¶å°±æ˜¯æ‚¨æœ€ç»ˆéœ€è¦çš„ï¼ŒåŒ…å«äº†peakå’Œå…¶ä¸´è¿‘åŸºå› çš„æ‰€æœ‰ä¿¡æ¯ã€‚
output_file <- "all_differential_peaks_annotated.csv"
write.csv(as.data.frame(peakAnno), file=output_file, row.names = FALSE)

cat("ğŸ‰ åˆ†æå½»åº•å®Œæˆï¼\n")
cat("è¯·åœ¨æ‚¨çš„å·¥ä½œç›®å½•ä¸­æŸ¥æ‰¾ä»¥ä¸‹æ–‡ä»¶ï¼š\n")
cat("1. all_differential_peaks_annotated.csv (æ‚¨è¦çš„è¡¨æ ¼)\n")
cat("2. peak_annotation_barplot.png (æ³¨é‡Šåˆ†å¸ƒå›¾)\n")
cat("3. peak_distance_to_TSS.png (TSSè·ç¦»å›¾)\n")
